{% extends "base.html" %}

{% block title %}Hacker News Report - Home{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Refresh button ---
        const refreshBtn = document.getElementById('refresh-posts-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', async function () {
                if (refreshBtn.classList.contains('loading')) return;

                refreshBtn.classList.add('loading');
                refreshBtn.disabled = true;
                const btnText = refreshBtn.querySelector('.btn-text');
                const originalText = btnText.textContent;
                btnText.textContent = 'Actualizando...';

                try {
                    const response = await fetch('/refresh');
                    const data = await response.json();

                    if (data.status === 'success') {
                        btnText.textContent = `¬°Listo! (${data.new_posts} nuevos)`;
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        throw new Error('Error en la respuesta');
                    }
                } catch (error) {
                    console.error('Refresh failed:', error);
                    btnText.textContent = 'Error al actualizar';
                    refreshBtn.classList.remove('loading');
                    refreshBtn.disabled = false;

                    setTimeout(() => {
                        btnText.textContent = originalText;
                    }, 3000);
                }
            });
        }

        // --- View toggle (list / grid) ---
        const VIEW_KEY = 'hnr-view-mode';
        const postsList = document.getElementById('posts-container');
        const btnList = document.getElementById('view-list-btn');
        const btnGrid = document.getElementById('view-grid-btn');
        if (!postsList || !btnList || !btnGrid) return;

        function setView(mode) {
            if (mode === 'grid') {
                postsList.classList.add('grid-view');
                postsList.classList.remove('list-view');
                btnGrid.classList.add('active');
                btnList.classList.remove('active');
            } else {
                postsList.classList.remove('grid-view');
                postsList.classList.add('list-view');
                btnList.classList.add('active');
                btnGrid.classList.remove('active');
            }
            localStorage.setItem(VIEW_KEY, mode);
        }

        // Restore saved preference (default: list)
        const saved = localStorage.getItem(VIEW_KEY) || 'list';
        setView(saved);

        btnList.addEventListener('click', () => setView('list'));
        btnGrid.addEventListener('click', () => setView('grid'));
    });
</script>
{% endblock %}

{% block content %}
<div class="sidebar">
    <h2>Categories</h2>
    <div class="category-list">
        <a href="/" class="category-item {% if current_category == 'all' %}active{% endif %}">
            <span class="category-name">All Posts</span>
            <span class="category-count">{{ stats.values()|sum if stats else 0 }}</span>
        </a>
        <a href="/?category=story" class="category-item {% if current_category == 'story' %}active{% endif %}">
            <span class="category-name">üìñ Stories</span>
            <span class="category-count">{{ stats.get('story', 0) }}</span>
        </a>
        <a href="/?category=job" class="category-item {% if current_category == 'job' %}active{% endif %}">
            <span class="category-name">üíº Jobs</span>
            <span class="category-count">{{ stats.get('job', 0) }}</span>
        </a>
        <a href="/?category=ask" class="category-item {% if current_category == 'ask' %}active{% endif %}">
            <span class="category-name">‚ùì Ask HN</span>
            <span class="category-count">{{ stats.get('ask', 0) }}</span>
        </a>
        <a href="/?category=poll" class="category-item {% if current_category == 'poll' %}active{% endif %}">
            <span class="category-name">üìä Polls</span>
            <span class="category-count">{{ stats.get('poll', 0) }}</span>
        </a>
        <a href="/?category=other" class="category-item {% if current_category == 'other' %}active{% endif %}">
            <span class="category-name">üìù Other</span>
            <span class="category-count">{{ stats.get('other', 0) }}</span>
        </a>
    </div>

    {% if tag_stats %}
    <h2 style="margin-top: 30px;">Popular Tags</h2>
    <div class="tag-cloud">
        {% for tag, count in (tag_stats.items()|list)[:15] %}
        <a href="/?tag={{ tag }}" class="tag-item {% if current_tag == tag %}active{% endif %}">
            {{ tag }} <span class="tag-count">({{ count }})</span>
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <div class="sidebar-section" style="margin-top: 30px;">
        <h2>Filters</h2>
        <div class="filter-options">
            <a href="{{ url_for('.index', ai_filter='off' if ai_filter == 'on' else 'on', category=current_category if current_category != 'search' else None, tag=current_tag) }}"
                class="filter-toggle"
                style="display: block; padding: 10px; background: white; border-radius: 8px; text-decoration: none; color: #333; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                {% if ai_filter == 'on' %}
                <span style="color: green;">‚úÖ</span> AI Highlighting (On)
                {% else %}
                <span style="color: #ccc;">‚¨ú</span> AI Highlighting (Off)
                {% endif %}
            </a>
        </div>
        {# AI model checkboxes partial #}
        {% include '_model_filters.html' %}
    </div>

    <div class="sidebar-section" style="margin-top: 30px;">
        <h2>Export Report</h2>
        <div class="report-options">
            {% set report_args = {} %}
            {% if search_query %} {% set _ = report_args.update({'q': search_query}) %} {% endif %}
            {% if current_tag %} {% set _ = report_args.update({'tag': current_tag}) %} {% endif %}
            {% if current_category and current_category != 'search' and current_category != 'all' %}
            {% set _ = report_args.update({'category': current_category}) %}
            {% endif %}
            {% if ai_filter %} {% set _ = report_args.update({'ai_filter': ai_filter}) %} {% endif %}

            <a href="{{ url_for('.generate_report', format='markdown', **report_args) }}"
                class="report-btn">Markdown</a>
            <a href="{{ url_for('.generate_report', format='html', **report_args) }}" class="report-btn">HTML</a>
            <a href="{{ url_for('.generate_report', format='csv', **report_args) }}" class="report-btn">CSV</a>
            <a href="{{ url_for('.generate_report', format='json', **report_args) }}" class="report-btn">JSON</a>
        </div>
    </div>

    <div class="sidebar-section" style="margin-top: 30px;">
        <h2>Blogs de Investigaci√≥n</h2>
        <div class="category-list">
            <a href="https://research.google/blog/" target="_blank" class="category-item">
                <span class="category-name">Gemini (Google)</span>
                <span class="external-link">‚Üó</span>
            </a>
            <a href="https://openai.com/es-419/research/" target="_blank" class="category-item">
                <span class="category-name">OpenAI</span>
                <span class="external-link">‚Üó</span>
            </a>
            <a href="https://www.anthropic.com/research" target="_blank" class="category-item">
                <span class="category-name">Anthropic</span>
                <span class="external-link">‚Üó</span>
            </a>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="header-section">
        <h2>
            {% if current_category == 'search' %}
            Search Results: "{{ search_query }}"
            {% elif current_category == 'all' %}
            All Posts
            {% elif current_category == 'story' %}
            Stories
            {% elif current_category == 'job' %}
            Job Postings
            {% elif current_category == 'ask' %}
            Ask HN
            {% elif current_category == 'poll' %}
            Polls
            {% else %}
            Other Posts
            {% endif %}
        </h2>
        <div class="header-actions" style="display: flex; align-items: center; gap: 20px;">
            <button id="refresh-posts-btn" class="refresh-btn">
                <span class="btn-icon">üîÑ</span>
                <div class="spinner"></div>
                <span class="btn-text">Actualizar Posts</span>
            </button>
            <div class="view-toggle" id="view-toggle">
                <button id="view-list-btn" class="view-toggle-btn active" aria-label="Vista lista" title="Vista lista">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <rect x="1" y="2" width="16" height="2.5" rx="1" fill="currentColor" />
                        <rect x="1" y="7.75" width="16" height="2.5" rx="1" fill="currentColor" />
                        <rect x="1" y="13.5" width="16" height="2.5" rx="1" fill="currentColor" />
                    </svg>
                </button>
                <button id="view-grid-btn" class="view-toggle-btn" aria-label="Vista grilla" title="Vista grilla">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                        <rect x="1" y="1" width="7" height="7" rx="1.5" fill="currentColor" />
                        <rect x="10" y="1" width="7" height="7" rx="1.5" fill="currentColor" />
                        <rect x="1" y="10" width="7" height="7" rx="1.5" fill="currentColor" />
                        <rect x="10" y="10" width="7" height="7" rx="1.5" fill="currentColor" />
                    </svg>
                </button>
            </div>
            <p class="post-count">{{ total_posts }} posts &middot; P√°gina {{ page }} de {{ total_pages }}</p>
        </div>
    </div>

    {% if posts %}
    <div id="posts-container" class="posts-list list-view">
        {% for post in posts %}
        <article class="post-card">
            <div class="post-header">
                <h3 class="post-title">
                    {% if post.url %}
                    <a href="{{ post.url }}" target="_blank" rel="noopener">{{ post.title | highlight_markdown | safe
                        }}</a>
                    <span class="external-link">‚Üó</span>
                    {% else %}
                    <a href="/post/{{ post.id }}">{{ post.title | highlight_markdown | safe }}</a>
                    {% endif %}
                </h3>
                <span class="post-category category-{{ post.category.value }}">{{ post.category.value }}</span>
            </div>

            <div class="post-meta">
                <span class="post-score">‚¨Ü {{ post.score }} points</span>
                <span class="post-author">by {{ post.author }}</span>
                <span class="post-date">{{ post.created_at|timestamp_to_date }}</span>
            </div>

            {% if post.tags %}
            <div class="post-tags">
                {% for tag in post.tags %}
                <a href="/?tag={{ tag }}" class="post-tag">{{ tag }}</a>
                {% endfor %}
            </div>
            {% endif %}

            {% if post.url %}
            <div class="post-url">
                <a href="{{ post.url }}" target="_blank" rel="noopener">{{ post.url|truncate(60) }}</a>
            </div>
            {% endif %}
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <h3>No posts found</h3>
        <p>Try fetching posts using the CLI:</p>
        <code>python -m src fetch --limit 30</code>
    </div>
    {% endif %}

    {% if total_pages > 1 %}
    <nav class="pagination" aria-label="Paginaci√≥n de posts">
        {# Previous button #}
        {% if page > 1 %}
        <a href="?{% for key, val in request.args.items(multi=True) %}{% if key != 'page' %}{{ key }}={{ val }}&{% endif %}{% endfor %}page={{ page - 1 }}"
            class="page-btn page-prev" aria-label="P√°gina anterior">
            ‚Üê Anterior
        </a>
        {% else %}
        <span class="page-btn page-prev disabled">‚Üê Anterior</span>
        {% endif %}

        {# Page numbers #}
        <div class="page-numbers">
            {% set start_page = [1, page - 2] | max %}
            {% set end_page = [total_pages, page + 2] | min %}

            {% if start_page > 1 %}
            <a href="?{% for key, val in request.args.items(multi=True) %}{% if key != 'page' %}{{ key }}={{ val }}&{% endif %}{% endfor %}page=1"
                class="page-num">1</a>
            {% if start_page > 2 %}
            <span class="page-ellipsis">‚Ä¶</span>
            {% endif %}
            {% endif %}

            {% for p in range(start_page, end_page + 1) %}
            {% if p == page %}
            <span class="page-num active" aria-current="page">{{ p }}</span>
            {% else %}
            <a href="?{% for key, val in request.args.items(multi=True) %}{% if key != 'page' %}{{ key }}={{ val }}&{% endif %}{% endfor %}page={{ p }}"
                class="page-num">{{ p }}</a>
            {% endif %}
            {% endfor %}

            {% if end_page < total_pages %} {% if end_page < total_pages - 1 %} <span class="page-ellipsis">‚Ä¶</span>
                {% endif %}
                <a href="?{% for key, val in request.args.items(multi=true) %}{% if key != 'page' %}{{ key }}={{ val }}&{% endif %}{% endfor %}page={{ total_pages }}"
                    class="page-num">{{ total_pages }}</a>
                {% endif %}
        </div>

        {# Next button #}
        {% if page < total_pages %} <a
            href="?{% for key, val in request.args.items(multi=true) %}{% if key != 'page' %}{{ key }}={{ val }}&{% endif %}{% endfor %}page={{ page + 1 }}"
            class="page-btn page-next" aria-label="P√°gina siguiente">
            Siguiente ‚Üí
            </a>
            {% else %}
            <span class="page-btn page-next disabled">Siguiente ‚Üí</span>
            {% endif %}
    </nav>
    {% endif %}
</div>
{% endblock %}